# -*- coding: cp1251 -*-
import csv
import random

import emoji
from dostoevsky.tokenization import RegexTokenizer
from dostoevsky.models import FastTextSocialNetworkModel
from regex import regex

from emoji_service import emoji_checker

abusive_language = ['6ëÿ', '6ëÿäü', '6ëÿòü', 'b3úeá', 'cock', 'cunt', 'e6aëü', 'ebal', 'eblan', 'eáaë', 'eáaòü', 'eáy÷',
                    'eáàòü', 'eá¸ò', 'eáëàíòèé', 'fuck', 'fucker', 'fucking', 'xy¸â', 'xyé', 'xyÿ', 'xóå', 'xóé', 'xóş',
                    'zaeb', 'zaebal', 'zaebali', 'zaebat', 'àğõèïèçäğèò', 'àõóåë', 'àõóåòü', 'áçäåíèå', 'áçäåòü',
                    'áçäåõ', 'áçäåöû', 'áçäèò', 'áçäèöû', 'áçäëî', 'áçäíóòü', 'áçäóí', 'áçäóíüÿ', 'áçäşõà', 'áçäşøêà',
                    'áçäşøêî', 'áëÿ', 'áëÿáó', 'áëÿáóäó', 'áëÿä', 'áëÿäè', 'áëÿäèíà', 'áëÿäèùå', 'áëÿäêè', 'áëÿäîâàòü',
                    'áëÿäñòâî', 'áëÿäóí', 'áëÿäóíû', 'áëÿäóíüÿ', 'áëÿäü', 'áëÿäşãà', 'áëÿòü', 'âàôåë', 'âàôë¸ğ',
                    'âçúåáêà', 'âçüåáêà', 'âçüåáûâàòü', 'âúåá', 'âúåáàëñÿ', 'âúåáåíí', 'âúåáóñü', 'âúåáûâàòü',
                    'âûáëÿäîê', 'âûáëÿäûø', 'âûåá', 'âûåáàòü', 'âûåáåí', 'âûåáíóëñÿ', 'âûåáîí', 'âûåáûâàòüñÿ',
                    'âûïåğäåòü', 'âûñğàòüñÿ', 'âûññàòüñÿ', 'âüåáåí', 'ãàâíî', 'ãàâíşê', 'ãàâíş÷êà', 'ãàìíî', 'ãàíäîí',
                    'ãíèä', 'ãíèäà', 'ãíèäû', 'ãîâåíêà', 'ãîâåííûé', 'ãîâåøêà', 'ãîâíàçèÿ', 'ãîâíåöî', 'ãîâíèùå',
                    'ãîâíî', 'ãîâíîåä', 'ãîâíîëèíê', 'ãîâíî÷èñò', 'ãîâíşê', 'ãîâíşõà', 'ãîâíÿäèíà', 'ãîâíÿê',
                    'ãîâíÿíûé', 'ãîâíÿòü', 'ãîíäîí', 'äîåáûâàòüñÿ', 'äîëáîåá', 'äîëáî¸á', 'äîëáîÿùåğ', 'äğèñíÿ',
                    'äğèñò', 'äğèñòàíóòü', 'äğèñòàòü', 'äğèñòóí', 'äğèñòóõà', 'äğî÷åëëî', 'äğî÷åíà', 'äğî÷èëà',
                    'äğî÷èëêà', 'äğî÷èñòûé', 'äğî÷èòü', 'äğî÷êà', 'äğî÷óí', 'å6àë', 'å6óò', 'ìàòü', 'ìàòü', '¸áaí',
                    'åáaòü', 'åáy÷', 'åáàë', 'åáàëî', 'åáàëüíèê', 'åáàí', 'åáàíàìàòü', 'åáàíàò', 'åáàíàÿ', '¸áàíàÿ',
                    'åáàíè÷åñêèé', 'åáàííûé', 'åáàííûéâğîò', 'åáàíîå', 'åáàíóòü', 'åáàíóòüñÿ', '¸áàíóş', 'åáàíûé',
                    'åáàíüêî', 'åáàğü', 'åáàò', '¸áàò', 'åáàòîğèÿ', 'åáàòü', 'åáàòü-êîïàòü', 'åáàòüñÿ', 'åáàøèòü',
                    'åá¸íà', 'åáåò', 'åá¸ò', 'åáåö', 'åáèê', 'åáèí', 'åáèñü', 'åáè÷åñêàÿ', 'åáêè', 'åáëà', 'åáëàí',
                    'åáëèâûé', 'åáëèùå', 'åáëî', 'åáëûñò', 'åáëÿ', '¸áí', 'åáíóòü', 'åáíóòüñÿ', 'åáíÿ', 'åáîøèòü',
                    'åáñêàÿ', 'åáñêèé', 'åáòâîşìàòü', 'åáóí', 'åáóò', 'åáó÷', 'åáó÷å', 'åáó÷åå', 'åáó÷èé', 'åáó÷èì',
                    'åáóù', 'åáûğü', 'åëäà', 'åëäàê', 'åëäà÷èòü', 'æîïà', 'æîïó', 'çàãîâíÿòü', 'çàäğà÷èâàòü',
                    'çàäğèñòàòü', 'çàäğîòà', 'çàå6', 'çà¸6', 'çàåá', 'çà¸á', 'çàåáà', 'çàåáàë', 'çàåáàíåö', 'çàåáàñòàÿ',
                    'çàåáàñòûé', 'çàåáàòü', 'çàåáàòüñÿ', 'çàåáàøèòü', 'çàåáèñòîå', 'çà¸áèñòîå', 'çàåáèñòûå',
                    'çà¸áèñòûå', 'çàåáèñòûé', 'çà¸áèñòûé', 'çàåáèñü', 'çàåáîøèòü', 'çàåáûâàòüñÿ', 'çàëóï', 'çàëóïà',
                    'çàëóïàòüñÿ', 'çàëóïèòü', 'çàëóïèòüñÿ', 'çàìóäîõàòüñÿ', 'çàïèçäÿ÷èòü', 'çàñåğàòü', 'çàñåğóí',
                    'çàñåğÿ', 'çàñèğàòü', 'çàñğóí', 'çàõóÿ÷èòü', 'çàÿáåñòàÿ', 'çëîåá', 'çëîåáó÷àÿ', 'çëîåáó÷åå',
                    'çëîåáó÷èé', 'èáàíàìàò', 'èáîíåõ', 'èçãîâíÿòü', 'èçãîâíÿòüñÿ', 'èçúåáíóòüñÿ', 'èïàòü', 'èïàòüñÿ',
                    'èïàööî', 'Êàêäâàïàëüöàîáîññàòü', 'êîí÷à', 'êóğâà', 'êóğâÿòíèê', 'ëîõ', 'ëîøàğa', 'ëîøàğà',
                    'ëîøàğû', 'ëîøîê', 'ëÿğâà', 'ìàëàôüÿ', 'ìàíäà', 'ìàíäàâîøåê', 'ìàíäàâîøêà', 'ìàíäàâîøêè', 'ìàíäåé',
                    'ìàíäåíü', 'ìàíäåòü', 'ìàíäèùà', 'ìàíäîé', 'ìàíäó', 'ìàíäşê', 'ìèíåò', 'ìèíåò÷èê', 'ìèíåò÷èöà',
                    'ìëÿòü', 'ìîêğîùåëêà', 'ìîêğîù¸ëêà', 'ìğàçü', 'ìóäak', 'ìóäaê', 'ìóäàã', 'ìóäàê', 'ìóäå', 'ìóäåëü',
                    'ìóäåòü', 'ìóäè', 'ìóäèë', 'ìóäèëà', 'ìóäèñòûé', 'ìóäíÿ', 'ìóäîåá', 'ìóäîçâîí', 'ìóäîêëşé', 'õåğ',
                    'õóé', 'íàáçäåë', 'íàáçäåòü', 'íàãîâíÿòü', 'íàäğèñòàòü', 'íàäğî÷èòü', 'íàåáàòü', 'íàåáåò',
                    'íàåáíóòü', 'íàåáíóòüñÿ', 'íàåáûâàòü', 'íàïèçäåë', 'íàïèçäåëè', 'íàïèçäåëî', 'íàïèçäèëè', 'íàñğàòü',
                    'íàñòîïèçäèòü', 'íàõåğ', 'íàõğåí', 'íàõóé', 'íàõóéíèê', 'åáåò', 'åá¸ò', 'íåâğîòåáó÷èé',
                    'íåâúåáåííî', 'íåõèğà', 'íåõğåí', 'Íåõóé', 'íåõóéñòâåííî', 'íèèáàöî', 'íèèïàööà', 'íèèïàööî',
                    'íèèïåò', 'íèêóÿ', 'íèõåğà', 'íèõóÿ', 'îáäğèñòàòüñÿ', 'îáîñğàíåö', 'îáîñğàòü', 'îáîñöàòü',
                    'îáîñöàòüñÿ', 'îáñèğàòü', 'îáúåáîñ', 'îáüåáîñ', 'îäíîõóéñòâåííî', 'îïåçäàë', 'îïèçäå',
                    'îïèçäåíèâàşùå', 'îñòîåáåíèòü', 'îñòîïèçäåòü', 'îòìóäîõàòü', 'îòïèçäèòü', 'îòïèçäÿ÷èòü', 'îòïîğîòü',
                    'îòúåáèñü', 'îõóåâàòåëüñêèé', 'îõóåâàòü', 'îõóåâàşùèé', 'îõóåë', 'îõóåííî', 'îõóåíü÷èê', 'îõóåòü',
                    'îõóèòåëüíî', 'îõóèòåëüíûé', 'îõóÿíü÷èê', 'îõóÿ÷èâàòü', 'îõóÿ÷èòü', 'î÷êóí', 'ïàäëà', 'ïàäîíêè',
                    'ïàäîíîê', 'ïàñêóäà', 'ïåäåğàñ', 'ïåäèê', 'ïåäğèê', 'ïåäğèëà', 'ïåäğèëëî', 'ïåäğèëî', 'ïåäğèëû',
                    'ïåçäåíü', 'ïåçäèò', 'ïåçäèøü', 'ïåçäî', 'ïåçäÿò', 'ïåğäàíóòü', 'ïåğäåæ', 'ïåğäåíèå', 'ïåğäåòü',
                    'ïåğäèëüíèê', 'ïåğäíóòü', 'ï¸ğäíóòü', 'ïåğäóí', 'ïåğäóíåö', 'ïåğäóíèíà', 'ïåğäóíüÿ', 'ïåğäóõà',
                    'ïåğäü', 'ïåğå¸áîê', 'ïåğíóòü', 'ï¸ğíóòü', 'ïè3ä', 'ïè3äå', 'ïè3äó', 'ïèzäåö', 'ïèäàğ', 'ïèäàğañ',
                    'ïèäàğàñ', 'ïèäàğàñû', 'ïèäàğû', 'ïèäîğ', 'ïèäîğàñû', 'ïèäîğêà', 'ïèäîğîê', 'ïèäîğû', 'ïèäğàñ',
                    'ïèçäà', 'ïèçäàíóòü', 'ïèçäàíóòüñÿ', 'ïèçäàğâàíü÷èê', 'ïèçäàòî', 'ïèçäàòîå', 'ïèçäàòûé', 'ïèçäåíêà',
                    'ïèçäåíûø', 'ïèçä¸íûø', 'ïèçäåòü', 'ïèçäåö', 'ïèçäèò', 'ïèçäèòü', 'ïèçäèòüñÿ', 'ïèçäèøü', 'ïèçäèùà',
                    'ïèçäèùå', 'ïèçäîáîë', 'ïèçäîáîëû', 'ïèçäîáğàòèÿ', 'ïèçäîâàòàÿ', 'ïèçäîâàòûé', 'ïèçäîëèç',
                    'ïèçäîíóòûå', 'ïèçäîğâàíåö', 'ïèçäîğâàíêà', 'ïèçäîñòğàäàòåëü', 'ïèçäó', 'ïèçäóé', 'ïèçäóí',
                    'ïèçäóíüÿ', 'ïèçäû', 'ïèçäşãà', 'ïèçäşê', 'ïèçäşëèíà', 'ïèçäşëÿ', 'ïèçäÿò', 'ïèçäÿ÷èòü', 'ïèñáøêè',
                    'ïèñüêà', 'ïèñüêîñòğàäàòåëü', 'ïèñşí', 'ïèñşøêà', 'õóé', 'õóş', 'ïîäãîâíÿòü', 'ïîäîíêè', 'ïîäîíîê',
                    'ïîäúåáíóòü', 'ïîäúåáíóòüñÿ', 'ïîåáàòü', 'ïîåáåíü', 'ïî¸áûâààåò', 'ïîñêóäà', 'ïîñğàòü', 'ïîòàñêóõà',
                    'ïîòàñêóøêà', 'ïîõåğ', 'ïîõåğèë', 'ïîõåğèëà', 'ïîõåğèëè', 'ïîõåğó', 'ïîõğåí', 'ïîõğåíó', 'ïîõóé',
                    'ïîõóèñò', 'ïîõóèñòêà', 'ïîõóş', 'ïğèäóğîê', 'ïğèåáàòüñÿ', 'ïğèïèçäåíü', 'ïğèïèçäíóòûé',
                    'ïğèïèçäşëèíà', 'ïğîáçäåëñÿ', 'ïğîáëÿäü', 'ïğîåá', 'ïğîåáàíêà', 'ïğîåáàòü', 'ïğîìàíäåòü',
                    'ïğîìóäåòü', 'ïğîïèçäåëñÿ', 'ïğîïèçäåòü', 'ïğîïèçäÿ÷èòü', 'ğàçäîëáàé', 'ğàçõóÿ÷èòü', 'ğàçúåá',
                    'ğàçúåáà', 'ğàçúåáàé', 'ğàçúåáàòü', 'ğàñïèçäàé', 'ğàñïèçäåòüñÿ', 'ğàñïèçäÿé', 'ğàñïèçäÿéñòâî',
                    'ğàñïğîåòü', 'ñâîëîòà', 'ñâîëî÷ü', 'ñãîâíÿòü', 'ñåêåëü', 'ñåğóí', 'ñåğüêà', 'ñåñòğîåá', 'ñèêåëü',
                    'ñèëà', 'ñèğàòü', 'ñèğûâàòü', 'ñîñè', 'ñïèçäåë', 'ñïèçäåòü', 'ñïèçäèë', 'ñïèçäèëà', 'ñïèçäèëè',
                    'ñïèçäèò', 'ñïèçäèòü', 'ñğàêà', 'ñğàêó', 'ñğàíûé', 'ñğàíüå', 'ñğàòü', 'ñğóí', 'ññàêà', 'ññûøü',
                    'ñòåğâà', 'ñòğàõîïèçäèùå', 'ñóêà', 'ñóêè', 'ñóõîäğî÷êà', 'ñó÷àğà', 'ñó÷èé', 'ñó÷êà', 'ñó÷êî',
                    'ñó÷îíîê', 'ñó÷üå', 'ñöàíèå', 'ñöàòü', 'ñöóêà', 'ñöóêè', 'ñöóêîíàõ', 'ñöóëü', 'ñöûõà', 'ñöûøü',
                    'ñúåáàòüñÿ', 'ñûêóí', 'òğàõàå6', 'òğàõàåá', 'òğàõà¸á', 'òğàõàòåëü', 'óáëşäîê', 'óåáàòü', 'ó¸áèùà',
                    'óåáèùå', 'ó¸áèùå', 'óåáèùíîå', 'ó¸áèùíîå', 'óåáê', 'óåáêè', 'ó¸áêè', 'óåáîê', 'ó¸áîê', 'óğşê',
                    'óñğàòüñÿ', 'óøëåïîê', 'õ_ó_ÿ_ğ_à', 'õy¸', 'õyé', 'õyéíÿ', 'õàìëî', 'õåğ', 'õåğíÿ', 'õåğîâàòî',
                    'õåğîâèíà', 'õåğîâûé', 'õèòğîâûåáàííûé', 'õèòğîæîïûé', 'õóeì', 'õóå', 'õó¸', 'õóåâàòî',
                    'õó¸âåíüêèé', 'õóåâèíà', 'õóåâî', 'õóåâûé', 'õó¸âûé', 'õóåê', 'õó¸ê', 'õóåë', 'õóåì', 'õóåí÷',
                    'õóåíûø', 'õóåíüêèé', 'õóåïëåò', 'õóåïë¸ò', 'õóåïğîìûøëåííèê', 'õóåğèê', 'õóåğûëî', 'õóåñîñ',
                    'õóåñîñêà', 'õóåòà', 'õóåòåíü', 'õóåş', 'õóè', 'õóé', 'õóéêîì', 'õóéëî', 'õóéíÿ', 'õóéğèê', 'õóèùå',
                    'õóëÿ', 'õóş', 'õóşë', 'õóÿ', 'õóÿê', 'õóÿêàòü', 'õóÿêíóòü', 'õóÿğà', 'õóÿñå', 'õóÿ÷èòü', 'öåëêà',
                    '÷ìî', '÷ìîøíèê', '÷ìûğü', 'øàëàâà', 'øàëàâîé', 'øàğà¸áèòüñÿ', 'øëşõà', 'øëşõîé', 'øëşøêà']


def distance(a, b):
    "Calculates the Levenshtein distance between a and b."
    n, m = len(a), len(b)
    if n > m:
        # Make sure n <= m, to use O(min(n, m)) space
        a, b = b, a
        n, m = m, n

    current_row = range(n + 1)  # Keep current and previous row, not entire matrix
    for i in range(1, m + 1):
        previous_row, current_row = current_row, [i] + [0] * n
        for j in range(1, n + 1):
            add, delete, change = previous_row[j] + 1, current_row[j - 1] + 1, previous_row[j - 1]
            if a[j - 1] != b[i - 1]:
                change += 1
            current_row[j] = min(add, delete, change)

    return current_row[n]


d = {'à': ['à', 'a', '@', '4'],
     'á': ['á', '6', 'b'],
     'â': ['â', 'b', 'v'],
     'ã': ['ã', 'r', 'g'],
     'ä': ['ä', 'd'],
     'å': ['å', 'e'],
     '¸': ['¸', 'e'],
     'æ': ['æ', 'zh', '*'],
     'ç': ['ç', '3', 'z'],
     'è': ['è', 'u', 'i'],
     'é': ['é', 'u', 'i'],
     'ê': ['ê', 'k', 'i{', '|{'],
     'ë': ['ë', 'l', 'ji'],
     'ì': ['ì', 'm'],
     'í': ['í', 'h', 'n'],
     'î': ['î', 'o', '0'],
     'ï': ['ï', 'n', 'p'],
     'ğ': ['ğ', 'r', 'p'],
     'ñ': ['ñ', 'c', 's'],
     'ò': ['ò', 'm', 't'],
     'ó': ['ó', 'y', 'u'],
     'ô': ['ô', 'f'],
     'õ': ['õ', 'x', 'h', '}{'],
     'ö': ['ö', 'c', 'u,'],
     '÷': ['÷', 'ch'],
     'ø': ['ø', 'sh'],
     'ù': ['ù', 'sch'],
     'ü': ['ü', 'b'],
     'û': ['û', 'bi'],
     'ú': ['ú'],
     'ı': ['ı', 'e'],
     'ş': ['ş', 'io'],
     'ÿ': ['ÿ', 'ya']
     }


def profanity_check(text):
    text = text.lower().replace(" ", "")

    for key, value in d.items():
        # Ïğîõîäèìñÿ ïî êàæäîé áóêâå â çíà÷åíèè ñëîâàğÿ. Òî åñòü ïî âîò ıòèì ñïèñêàì ['à', 'a', '@'].
        for letter in value:
            # Ïğîõîäèìñÿ ïî êàæäîé áóêâå â íàøåé ôğàçå.
            for phr in text:
                # Åñëè áóêâà ñîâïàäàåò ñ áóêâîé â íàøåì ñïèñêå.
                if letter == phr:
                    # Çàìåíÿåì ıòó áóêâó íà êëş÷ ñëîâàğÿ.
                    text = text.replace(phr, key)

    flag = False

    for word in abusive_language:
        # Ğàçáèâàåì ñëîâî íà ÷àñòè, è ïğîõîäèìñÿ ïî íèì.
        for part in range(len(text)):
            # Âîò ñàì íàø ôğàãìåíò.
            fragment = text[part: part + len(word)]
            # Åñëè îòëè÷èå ıòîãî ôğàãìåíòà ìåíüøå èëè ğàâíî 25% ıòîãî ñëîâà, òî ñ÷èòàåì, ÷òî îíè ğàâíû.
            if distance(fragment, word) <= len(word) * 0.25:
                # Åñëè îíè ğàâíû, âûâîäèì íàäïèñü î èõ íàõîæäåíèè.
                flag = True

        if flag:
            break

    return flag


def text_mood(text):
    FastTextSocialNetworkModel.MODEL_PATH = 'fasttext-social-network-model.bin'
    tokenizer = RegexTokenizer()
    model = FastTextSocialNetworkModel(tokenizer=tokenizer)

    messages = [
        text
    ]

    n = random.randint(1, 10)
    print('random', n)
    results = model.predict(messages, k=n)

    for message, sentiment in zip(messages, results):
        print(sentiment)

    result = max(sentiment, key=sentiment.get)

    if result == 'neutral':
        result = emoji_checker(text, result)

    return result
